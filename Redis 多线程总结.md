# Redis IOäº‹ä»¶æºç 

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹6.0ç‰ˆæœ¬çš„Redis IOçš„æ€»ä½“äº‹ä»¶å¤„ç†æµç¨‹æ¦‚è§ˆå›¾[^1]

<img src="https://img.taohuawu.club/gallery/multiple-threaded-redis.png?imageView2/2/w/1280/format/jpg/interlace/1/q/100" alt="img" style="zoom: 200% width=500;"  />



### ğŸ¨å¤šçº¿ç¨‹å¤„ç†äº‹ä»¶ä¸»è¦æµç¨‹è§£æ

1. åˆå§‹åŒ–RedisæœåŠ¡å™¨`server.c -> main() --> initServer()`,
   1. å¼€å¯ä¸»çº¿ç¨‹çš„äº‹ä»¶å¾ªç¯`EventLoop`
   1. ç»‘å®šç«¯å£
   1. åˆ›å»ºæ—¶é—´äº‹ä»¶å¹¶ç»‘å®šæ—¶é—´äº‹ä»¶handlerä¸º`serverCron()`
   1. ä¸ºå½“å‰æ‰€æœ‰çš„æ–‡ä»¶äº‹ä»¶åˆ›å»ºTCP connectionçš„handlerä¸º`acceptTcpHandler()`ï¼Œç­‰å¾…æ–°çš„è¿æ¥å»ºç«‹
   1. æ³¨å†Œäº‹ä»¶å¾ªç¯ä¸­çš„beforeSleepProcå’ŒafterSleepProcä¸º`beforeSleep()`å’Œ`afterSleep()`
2. å®¢æˆ·ç«¯clientä¸serverå»ºç«‹è¿æ¥
3. `accepTcpHandler()`å‡½æ•°è¢«è°ƒç”¨
4. ä¸»çº¿ç¨‹å°†`readQueryFromClient()`å‡½æ•°ç»‘å®šåˆ°å®¢æˆ·ç«¯å¯è¯»äº‹ä»¶å¤„ç†å™¨ä¸Šï¼Œ`createClient() -> connSetReadHandler()`
5. å®¢æˆ·ç«¯è§¦å‘è¯»å°±ç»ªäº‹ä»¶ï¼Œå¦‚æœé…ç½®äº†å¤šçº¿ç¨‹ï¼Œä¸»çº¿ç¨‹å°†è°ƒç”¨`postponeClientRead()`å°†clientæ”¾å…¥`clients_pending_read`é˜Ÿåˆ—çš„å¤´éƒ¨
6. éšåä¸»çº¿ç¨‹ä¼šæ‰§è¡Œ`beforeSleep() -> handleClientsWithPendingReadsUsingThreads()`,å°†`clients_pending_read`ä¸­çš„clientä¾ç…§Round Robinè½®è¯¢çš„æ–¹å¼æ”¾å…¥æœ¬åœ°çš„ä»»åŠ¡é˜Ÿåˆ—`io_thread_list[id]`çš„å°¾ç«¯å’Œä¸»çº¿ç¨‹è‡ªå·±çš„ä»»åŠ¡é˜Ÿåˆ—ã€‚åŒæ—¶è®¾ç½®`io_threads_pending`é˜Ÿåˆ—ä¸­å„ä¸ªIOçº¿ç¨‹éœ€è¦å¤„ç†çš„è¯»äº‹ä»¶çš„ä¸ªæ•°ï¼ˆçŒœæµ‹æ˜¯æ¥æ¿€æ´»IOçº¿ç¨‹è¿›è¡Œå·¥ä½œï¼‰
   1. I/O çº¿ç¨‹é€šè¿‡ socket è¯»å–å®¢æˆ·ç«¯çš„è¯·æ±‚å‘½ä»¤ï¼Œå­˜å…¥ `client->querybuf` å¹¶è§£æç¬¬ä¸€ä¸ªå‘½ä»¤ï¼Œ**ä½†ä¸æ‰§è¡Œå‘½ä»¤**ï¼Œä¸»çº¿ç¨‹å¿™è½®è¯¢ï¼Œç­‰å¾…æ‰€æœ‰ I/O çº¿ç¨‹å®Œæˆè¯»å–ä»»åŠ¡ï¼›

7. ä¸»çº¿ç¨‹å’Œæ‰€æœ‰ I/O çº¿ç¨‹éƒ½å®Œæˆäº†è¯»å–ä»»åŠ¡ï¼Œä¸»çº¿ç¨‹ç»“æŸå¿™è½®è¯¢ï¼Œéå† `clients_pending_read` é˜Ÿåˆ—ï¼Œ**æ‰§è¡Œæ‰€æœ‰å®¢æˆ·ç«¯è¿æ¥çš„è¯·æ±‚å‘½ä»¤**ï¼Œå…ˆè°ƒç”¨ `processCommandAndResetClient` æ‰§è¡Œç¬¬ä¸€æ¡å·²ç»è§£æå¥½çš„å‘½ä»¤ï¼Œç„¶åè°ƒç”¨ `processInputBuffer` è§£æå¹¶æ‰§è¡Œå®¢æˆ·ç«¯è¿æ¥çš„æ‰€æœ‰å‘½ä»¤ï¼Œåœ¨å…¶ä¸­ä½¿ç”¨ `processInlineBuffer` æˆ–è€… `processMultibulkBuffer` æ ¹æ® Redis åè®®è§£æå‘½ä»¤ï¼Œæœ€åè°ƒç”¨ `processCommand` æ‰§è¡Œå‘½ä»¤
8. æ ¹æ®è¯·æ±‚å‘½ä»¤çš„ç±»å‹ï¼ˆSET, GET, DEL, EXEC ç­‰ï¼‰ï¼Œåˆ†é…ç›¸åº”çš„å‘½ä»¤æ‰§è¡Œå™¨å»æ‰§è¡Œï¼Œæœ€åè°ƒç”¨ `addReply()` å‡½æ•°æ—çš„ä¸€ç³»åˆ—å‡½æ•°å°†å“åº”æ•°æ®å†™å…¥åˆ°å¯¹åº” `client` çš„å†™å‡ºç¼“å†²åŒºï¼š`client->buf` æˆ–è€… `client->reply` ï¼Œ`client->buf` æ˜¯é¦–é€‰çš„å†™å‡ºç¼“å†²åŒºï¼Œå›ºå®šå¤§å° 16KBï¼Œä¸€èˆ¬æ¥è¯´å¯ä»¥ç¼“å†²è¶³å¤Ÿå¤šçš„å“åº”æ•°æ®ï¼Œä½†æ˜¯å¦‚æœå®¢æˆ·ç«¯åœ¨æ—¶é—´çª—å£å†…éœ€è¦å“åº”çš„æ•°æ®éå¸¸å¤§ï¼Œé‚£ä¹ˆåˆ™ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ° `client->reply` é“¾è¡¨ä¸Šå»ï¼Œä½¿ç”¨é“¾è¡¨ç†è®ºä¸Šèƒ½å¤Ÿä¿å­˜æ— é™å¤§çš„æ•°æ®ï¼ˆå—é™äºæœºå™¨çš„ç‰©ç†å†…å­˜ï¼‰ï¼Œæœ€åæŠŠ `client` æ·»åŠ è¿›ä¸€ä¸ª LIFO é˜Ÿåˆ— `clients_pending_write`
9. åœ¨äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰ä¸­ï¼Œä¸»çº¿ç¨‹æ‰§è¡Œ `beforeSleep()` --> `handleClientsWithPendingWritesUsingThreads()`ï¼Œåˆ©ç”¨ Round-Robin è½®è¯¢è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼ŒæŠŠ `clients_pending_write` é˜Ÿåˆ—ä¸­çš„è¿æ¥å‡åŒ€åœ°åˆ†é…ç»™ I/O çº¿ç¨‹å„è‡ªçš„æœ¬åœ° FIFO ä»»åŠ¡é˜Ÿåˆ— `io_threads_list[id]` å’Œä¸»çº¿ç¨‹è‡ªå·±ï¼ŒI/O çº¿ç¨‹é€šè¿‡è°ƒç”¨ `writeToClient` æŠŠ `client` çš„å†™å‡ºç¼“å†²åŒºé‡Œçš„æ•°æ®å›å†™åˆ°å®¢æˆ·ç«¯ï¼Œä¸»çº¿ç¨‹å¿™è½®è¯¢ï¼Œç­‰å¾…æ‰€æœ‰ I/O çº¿ç¨‹å®Œæˆå†™å‡ºä»»åŠ¡ï¼›
10. ä¸»çº¿ç¨‹å’Œæ‰€æœ‰ I/O çº¿ç¨‹éƒ½å®Œæˆäº†å†™å‡ºä»»åŠ¡ï¼Œ ä¸»çº¿ç¨‹ç»“æŸå¿™è½®è¯¢ï¼Œéå† `clients_pending_write` é˜Ÿåˆ—ï¼Œå¦‚æœ `client` çš„å†™å‡ºç¼“å†²åŒºè¿˜æœ‰æ•°æ®é—ç•™ï¼Œåˆ™æ³¨å†Œ `sendReplyToClient()` åˆ°è¯¥è¿æ¥çš„å†™å°±ç»ªäº‹ä»¶ï¼Œç­‰å¾…å®¢æˆ·ç«¯å¯å†™æ—¶åœ¨äº‹ä»¶å¾ªç¯ä¸­å†ç»§ç»­å›å†™æ®‹ä½™çš„å“åº”æ•°æ®ã€‚


[^1]: https://strikefreedom.top/multiple-threaded-network-model-in-redis Rediså¤šçº¿ç¨‹ç½‘ç»œæ¨¡å‹å…¨é¢æ­ç§˜

